## Semihosting 

### 1. 什么是 semihosting ?

​	它使在嵌入式系统（也称为目标）上运行的代码能够主动调起 PC 机上的 C库函数，来实现 IO 操作。这是通过停止目标程序来完成的，在大多数情况下，在代码中的某个点使用某种断点指令，或者使用模式开关（CortexA/R 中的 SVC 模式）

### 2. 基本操作

​	目标 cpu 被暂停，要么通过运行断点指令，要么通过一些其他操作停止程序并将目标 CPU 置于调试代理的控制之下。

​	调试代理可以是调试探针（jlink）或调试器（gdb，segger ozone）。调试器读取一个或多个寄存器以确定主机代表目标要执行的操作类型，然后执行该操作，然后重新启动目标，目标在 semihosting 操作期间暂停。

### 3. 停止目标 CPU 的方法

​	有不同的方法可以暂停目标 CPU，主要是特殊调用，如 “主管调用（supervisor cal）” 或断点。ARM 的 Cortex-M 实现存在以下问题：它使用断点指令（bkpt），如果 CPU 未在调试模式下运行，则会导致硬故障。处理这个问题的方法是使用一个特事故的硬故障处理程序，该程序检查问题的根源，并允许跳过 BKPT 指令并恢复程序执行

### 4. 软件断点

​	Cortex-M 设备可以使用软件断点指令（BKPT）而不是主管调用。连接调试器后，目标在执行BKPT时将暂停。通过软件断点的半托管由可以使用 BKPT 指令编码的参数触发

​	BKPT 始终是具有 8 位参数的 16 位指令。半托管的标准参数是 0xAB

semihosting  是一种机制，就是让板子通过这种机制，能够与在运行调试器的主机上通信，就是板子能够与pc通信，调试器做中间桥梁，并且能够主动的调用起 pc 机上的C库函数，来实现IO操作，比如可以读写PC机上的文件

通常情况下，半主机由库函数中的代码调用。应用程序还可以直接调用半托管操作。

注意：ARMv7 之前的 arm 处理器使用 SVC 指令（以前成为 SWI 指令）进行 semihosting 调用。但是如果要针对 ARMv6-M 或 ARMv7-M 编译，例如 CortexM1 或 Cortex-M3 处理器，semihosting 是使用 BKPT 指令实现的

Cortex-A 和 Cortex-R 设备通常使用 supervisor call （SVC） 进行半托管。

